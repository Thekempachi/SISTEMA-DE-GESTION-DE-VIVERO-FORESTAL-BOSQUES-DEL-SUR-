<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Vivero Bosques del Sur</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="header-title">
        <h1>Vivero "Bosques del Sur" - Sistema de Gesti√≥n</h1>
      </div>
      <div class="header-user-section">
        <div id="user-info" class="user-info">
          <span id="user-name"></span>
        </div>
        <button 
          type="button" 
          id="logout-btn" 
          class="btn-logout-header" 
          title="Cerrar sesi√≥n actual y volver al inicio"
          aria-label="Cerrar sesi√≥n de usuario"
          onclick="handleLogoutClick()"
        >
          <span class="logout-icon">üö™</span>
          <span class="logout-text">Cerrar Sesi√≥n</span>
        </button>
      </div>
    </div>
  </header>
  <nav>
    <button type="button" data-target="dashboard">Dashboard</button>
    <button type="button" data-target="especies">Especies</button>
    <button type="button" data-target="lotes">Lotes</button>
    <button type="button" data-target="fases">Fases</button>
    <button type="button" data-target="tratamientos">Tratamientos</button>
    <button type="button" data-target="condiciones">Condiciones</button>
    <button type="button" data-target="plantas">Plantas</button>
    <button type="button" data-target="inventario">Inventario</button>
    <button type="button" data-target="despachos">Despachos</button>
  </nav>
  <main>
    <section id="dashboard" class="active">
      <div class="grid">
        <div class="card">
          <h3>Indicadores Clave (KPI)</h3>
          <div class="grid">
            <div class="card"><div class="muted">Especies</div><div class="kpi-number" id="kpi-especies">‚Äì</div></div>
            <div class="card"><div class="muted">Lotes</div><div class="kpi-number" id="kpi-lotes">‚Äì</div></div>
            <div class="card"><div class="muted">Plantas</div><div class="kpi-number" id="kpi-plantas">‚Äì</div></div>
            <div class="card"><div class="muted">√ìrdenes</div><div class="kpi-number" id="kpi-ordenes">‚Äì</div></div>
          </div>
        </div>
        <div class="card">
          <h3>Resumen de Inventario</h3>
          <table>
            <thead><tr><th>Clasificaci√≥n</th><th>Cantidad</th></tr></thead>
            <tbody id="inv-resumen"></tbody>
          </table>
        </div>
        <div class="card">
          <h3>√öltimos Lotes</h3>
          <table>
            <thead><tr><th>C√≥digo</th><th>Especie</th><th>Fecha</th></tr></thead>
            <tbody id="ult-lotes"></tbody>
          </table>
        </div>
        <div class="card">
          <h3>Base de Datos</h3>
          <p>Verifica la conexi√≥n y estado de la base de datos.</p>
          <div class="actions">
            <button type="button" id="test-db-btn">Probar Conexi√≥n</button> 
            <button type="button" id="init-db-btn">Inicializar BD</button>
            <button type="button" id="seed-btn">Cargar Datos</button>
            <span id="db-msg" class="muted"></span>
          </div>
        </div>
      </div>
    </section>

    <section id="especies">
      <h2>Especies</h2>
      <form id="form-especie">
        <div class="row">
          <div>
            <label for="es-nombre-comun">Nombre com√∫n</label>
            <input id="es-nombre-comun" name="nombre_comun" required />
          </div>
          <div>
            <label for="es-nombre-cientifico">Nombre cient√≠fico</label>
            <input id="es-nombre-cientifico" name="nombre_cientifico" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="tipo-especie">Tipo de especie</label>
            <select name="tipo_especie_id" id="tipo-especie"></select>
          </div>
          <div>
            <label for="es-categoria">Categor√≠a</label>
            <input id="es-categoria" name="categoria" />
          </div>
        </div>
        <div>
          <label for="es-descripcion">Descripci√≥n</label>
          <textarea id="es-descripcion" name="descripcion"></textarea>
        </div>
        <div class="actions"><button type="submit">Guardar</button><span id="especie-msg" class="muted"></span></div>
      </form>
      <h3>Listado</h3>
      <table>
        <thead><tr><th>ID</th><th>Nombre com√∫n</th><th>Nombre cient√≠fico</th><th>Tipo</th></tr></thead>
        <tbody id="tabla-especies"></tbody>
      </table>
    </section>

    <section id="lotes">
      <h2>Registrar Lote de Producci√≥n</h2>
      <form id="form-lote">
        <fieldset class="card">
          <legend>Proveedor</legend>
          <div class="row">
            <div><label for="p-nombre">Nombre</label><input id="p-nombre" name="p_nombre" required /></div>
            <div><label for="p-contacto">Contacto</label><input id="p-contacto" name="p_contacto" /></div>
          </div>
          <div class="row">
            <div><label for="p-telefono">Tel√©fono</label><input id="p-telefono" name="p_telefono" /></div>
            <div><label for="p-email">Email</label><input id="p-email" name="p_email" /></div>
          </div>
        </fieldset>
        <fieldset class="card">
          <legend>Lote de Semillas</legend>
          <div class="row">
            <div><label for="ls-procedencia">Procedencia</label><input id="ls-procedencia" name="ls_procedencia" /></div>
            <div><label for="ls-certificado">Certificado</label><input id="ls-certificado" name="ls_certificado" /></div>
          </div>
          <div class="row">
            <div><label for="ls-tasa">Tasa germinaci√≥n (%)</label><input id="ls-tasa" name="ls_tasa" type="number" step="0.01" /></div>
            <div><label for="ls-observaciones">Observaciones</label><input id="ls-observaciones" name="ls_observaciones" /></div>
          </div>
        </fieldset>
        <fieldset class="card">
          <legend>Lote de Producci√≥n</legend>
          <div class="row">
            <div>
              <label for="lp-especie">Especie</label>
              <select name="lp_especie_id" id="lp-especie"></select>
            </div>
            <div><label for="lp-fecha">Fecha siembra</label><input id="lp-fecha" name="lp_fecha" type="date" required /></div>
          </div>
          <div class="row">
            <div><label for="lp-cantidad">Cantidad de semillas usadas</label><input id="lp-cantidad" name="lp_cantidad" type="number" required /></div>
            <div><label for="lp-notas">Notas</label><input id="lp-notas" name="lp_notas" /></div>
          </div>
        </fieldset>
        <div class="actions"><button type="submit">Crear Lote</button><span id="lote-msg" class="muted"></span></div>
      </form>
      <h3>Lotes Registrados</h3>
      <table>
        <thead><tr><th>C√≥digo</th><th>Especie</th><th>Fecha Siembra</th><th>Semillas</th><th>Proveedor</th></tr></thead>
        <tbody id="tabla-lotes"></tbody>
      </table>
    </section>

    <section id="fases">
      <h2>Gesti√≥n de Fases</h2>
      <div class="grid">
        <div class="card">
          <h3>Iniciar Fase</h3>
          <form id="form-iniciar-fase">
            <label for="if-lote">Lote</label>
            <select id="if-lote"></select>
            <label for="if-fase">Fase</label>
            <select id="if-fase"></select>
            <label for="if-ubicacion">Ubicaci√≥n</label>
            <select id="if-ubicacion"></select>
            <label for="if-stock">Stock inicial</label>
            <input id="if-stock" type="number" />
            <div class="actions"><button type="submit">Iniciar</button><span id="if-msg" class="muted"></span></div>
          </form>
        </div>
        <div class="card">
          <h3>Cerrar Fase</h3>
          <form id="form-cerrar-fase">
            <label for="cf-lote">Lote</label>
            <select id="cf-lote"></select>
            <label for="cf-lote-fase">Fase activa del lote</label>
            <select id="cf-lote-fase"></select>
            <div class="row">
              <div><label for="cf-avanzan">Plantas avanzan</label><input id="cf-avanzan" type="number" required /></div>
              <div><label for="cf-perdidas">Perdidas</label><input id="cf-perdidas" type="number" value="0" /></div>
            </div>
            <div class="row">
              <div><label for="cf-descartes">Descartes</label><input id="cf-descartes" type="number" value="0" /></div>
              <div><label for="cf-observaciones">Observaciones</label><input id="cf-observaciones" /></div>
            </div>
            <div class="actions"><button type="submit">Cerrar</button><span id="cf-msg" class="muted"></span></div>
          </form>
        </div>
      </div>
      <h3>Historial del Lote</h3>
      <label for="hist-lote">Lote</label>
      <select id="hist-lote"></select>
      <table>
        <thead><tr><th>Fase</th><th>Estado</th><th>Inicio</th><th>Fin</th><th>Stock Inicial</th><th>Stock Disp.</th></tr></thead>
        <tbody id="tabla-fases"></tbody>
      </table>
    </section>

    <section id="tratamientos">
      <h2>Tratamientos</h2>
      <form id="form-tratamiento">
        <label for="tr-lote-fase">Lote-Fase</label>
        <input id="tr-lote-fase" placeholder="ID de lote_fase" />
        <label for="tr-tipo">Tipo</label>
        <select id="tr-tipo"></select>
        <label for="tr-fecha">Fecha</label>
        <input id="tr-fecha" type="datetime-local" />
        <label for="tr-producto">Producto</label>
        <input id="tr-producto" />
        <label for="tr-dosis">Dosis</label>
        <input id="tr-dosis" />
        <label for="tr-motivo">Motivo</label>
        <input id="tr-motivo" />
        <label for="tr-observaciones">Observaciones</label>
        <input id="tr-observaciones" />
        <div class="actions"><button type="submit">Registrar</button><span id="tr-msg" class="muted"></span></div>
      </form>
    </section>

    <section id="condiciones">
      <h2>Condiciones Ambientales</h2>
      <form id="form-condicion">
        <label for="co-lote-fase">Lote-Fase</label>
        <input id="co-lote-fase" placeholder="ID de lote_fase" />
        <label for="co-ubicacion">Ubicaci√≥n</label>
        <select id="co-ubicacion"></select>
        <div class="row">
          <div><label for="co-fecha">Fecha</label><input id="co-fecha" type="datetime-local" /></div>
          <div><label for="co-temp">Temperatura (¬∞C)</label><input id="co-temp" type="number" step="0.01" /></div>
        </div>
        <div class="row">
          <div><label for="co-hum">Humedad (%)</label><input id="co-hum" type="number" step="0.01" /></div>
          <div><label for="co-prec">Precipitaciones (mm)</label><input id="co-prec" type="number" step="0.01" /></div>
        </div>
        <label for="co-obs">Observaciones</label>
        <input id="co-obs" />
        <div class="actions"><button type="submit">Registrar</button><span id="co-msg" class="muted"></span></div>
      </form>
    </section>

    <section id="plantas">
      <h2>Plantas (Fase 3+)</h2>
      <form id="form-planta">
        <label for="pl-lote">Lote</label>
        <select id="pl-lote"></select>
        <label for="pl-salud">Estado de salud</label>
        <select id="pl-salud"></select>
        <label for="pl-altura">Altura (cm)</label>
        <input id="pl-altura" type="number" step="0.01" />
        <label for="pl-ubicacion">Ubicaci√≥n</label>
        <select id="pl-ubicacion"></select>
        <div class="row">
          <div>
            <label for="pl-calidad">Clasificaci√≥n inicial</label>
            <select id="pl-calidad"></select>
          </div>
          <div>
            <label for="pl-tamano">Tama√±o inicial</label>
            <select id="pl-tamano"></select>
          </div>
        </div>
        <div class="actions"><button type="submit">Etiquetar</button><span id="pl-msg" class="muted"></span></div>
      </form>
      <div id="pl-qr" class="mt-12"></div>
      <div id="pl-ficha" class="card mt-12"></div>
      <h3>√öltimas plantas</h3>
      <table>
        <thead><tr><th>ID</th><th>QR</th><th>Especie</th><th>Altura</th></tr></thead>
        <tbody id="tabla-plantas"></tbody>
      </table>
    </section>

    <section id="inventario">
      <h2>Inventario</h2>
      <form id="form-inventario">
        <label for="inv-planta-id">Planta</label>
        <input id="inv-planta-id" placeholder="ID planta" />
        <label for="inv-calidad">Clasificaci√≥n</label>
        <select id="inv-calidad"></select>
        <label for="inv-tamano">Tama√±o</label>
        <select id="inv-tamano"></select>
        <div class="actions"><button type="submit">Actualizar</button><span id="inv-msg" class="muted"></span></div>
      </form>
      <h3>√öltimos cambios</h3>
      <table>
        <thead><tr><th>Planta</th><th>QR</th><th>Especie</th><th>Clasificaci√≥n</th><th>Tama√±o</th></tr></thead>
        <tbody id="tabla-inventario"></tbody>
      </table>
    </section>

    <section id="despachos">
      <h2>Despachos</h2>
      <form id="form-orden">
        <label for="od-destino">Destino (ID)</label>
        <input id="od-destino" placeholder="ID destino (gestiona por DB)" />
        <label for="od-fecha">Fecha</label>
        <input id="od-fecha" type="datetime-local" />
        <label for="od-resp">Responsable (usuario id)</label>
        <input id="od-resp" value="1" />
        <label for="od-trans">Personal de Transporte</label>
        <input id="od-trans" />
        <label for="od-notas">Notas</label>
        <input id="od-notas" />
        <div class="actions"><button type="submit">Crear Orden</button><span id="od-msg" class="muted"></span></div>
      </form>
      <form id="form-orden-linea" class="mt-12">
        <label for="ol-orden">Orden ID</label>
        <input id="ol-orden" />
        <label for="ol-planta">Planta ID</label>
        <input id="ol-planta" />
        <label for="ol-cant">Cantidad</label>
        <input id="ol-cant" type="number" />
        <label for="ol-estado">Estado al despacho</label>
        <select id="ol-estado"></select>
        <label for="ol-obs">Observaciones</label>
        <input id="ol-obs" />
        <div class="actions"><button type="submit">Agregar L√≠nea</button><span id="ol-msg" class="muted"></span></div>
      </form>
      <h3>√ìrdenes</h3>
      <table>
        <thead><tr><th>N√∫mero</th><th>Destino</th><th>Fecha</th><th>Responsable</th><th>L√≠neas</th></tr></thead>
        <tbody id="tabla-ordenes"></tbody>
      </table>
    </section>

  </main>
  
  <footer>
    <div class="footer-content">
      <!-- Footer content -->
    </div>
  </footer>
  <!-- Scripts al final del body -->
  <script type="module" src="../js/main.js"></script>
  
  <!-- Funci√≥n de logout global como fallback -->
  <script>
    async function handleLogoutClick() {
      console.log('Logout clicked via onclick handler');
      
      const confirmLogout = confirm('¬øEst√°s seguro de que deseas cerrar la sesi√≥n?');
      if (!confirmLogout) return;

      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.innerHTML = '<span class="logout-icon">‚è≥</span><span class="logout-text">Cerrando...</span>';
        logoutBtn.disabled = true;
      }

      try {
        // Llamar a la API de logout
        const response = await fetch('../../backend/php/api/auth.php?action=logout', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        
        console.log('Logout API response:', response.status);
      } catch (e) {
        console.log('Logout API failed:', e.message);
      }

      // Limpiar datos locales
      localStorage.clear();
      sessionStorage.clear();
      console.log('Local data cleared');

      // Mostrar √©xito
      if (logoutBtn) {
        logoutBtn.innerHTML = '<span class="logout-icon">‚úì</span><span class="logout-text">¬°Sesi√≥n cerrada!</span>';
      }

      // Redirigir al login
      setTimeout(() => {
        console.log('Redirecting to login...');
        window.location.href = './login.html';
      }, 800);
    }

    // Tambi√©n configurar el evento cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        console.log('Configurando logout button via DOMContentLoaded');
        // Remover onclick anterior si existe
        logoutBtn.removeAttribute('onclick');
        logoutBtn.addEventListener('click', handleLogoutClick);
      }
    });
  </script>
</body>
</html>
